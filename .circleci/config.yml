version: 2.1

orbs:
  cypress: cypress-io/cypress@1.26.0

jobs:
  build:
    docker:
      - image: circleci/golang:latest-node
      - image: circleci/postgres:latest-postgis
        environment:
          POSTGRES_USER: test
          POSTGRES_DB: test
          POSTGRES_PASSWORD: test

    working_directory: ~/GlobeTrotte

    steps:
      - checkout
      - restore_cache:
          key: please-{{ checksum "pleasew" }}
      - restore_cache:
          key: pnpm-store-{{ checksum "package.json" }}
      - restore_cache:
          key: cypress-6.2.0
      - restore_cache:
          key: node-modules-{{ checksum "package.json" }}
      - run: sudo apt-get install -y libasound2 libgbm-dev libgconf-2-4 libgtk2.0-0 libgtk-3-0 libnotify-dev libnss3 libxcomposite-dev libxcomposite1 libxss1 libxtst6 postgresql-client xauth xvfb
      - run: /usr/bin/Xvfb :99 -screen 0 1920x1080x24+32 &

      - run: echo 'export DISPLAY=:99' >> $BASH_ENV
      - run: echo 'export PATH=/home/circleci/.nimble/bin:$HOME/wings:$PATH' >> $BASH_ENV
      - run: echo 'export USER="circleci"' >> $BASH_ENV
      - run: ./scripts/setup.sh -g -s -w

      - run: sudo npm i -g pnpm
      - run: pnpx cypress install
      - run: cp .circleci/test.config config/psql.config
      - run: dockerize -wait tcp://localhost:5432 -timeout 1m

      # run tests
      - run: ./pleasew build --show_all_output
      - run: ./pleasew cover --show_all_output //src/turbine/...
      - run:
          command: ./pleasew work
          background: true
      - run: pnpm run test:ava
      - run: ./pleasew test --show_all_output
      - run: ./pleasew run //:report
      - run: bash <(curl -s https://codecov.io/bash)
      - run: ./scripts/leftover.sh
      - save_cache:
          key: please-{{ checksum "pleasew" }}
          paths:
            - ~/.please
      - save_cache:
          key: pnpm-store-{{ checksum "package.json" }}
          paths:
            - ~/.pnpm-store
      - save_cache:
          key: cypress-6.2.0
          paths:
            - ~/.cache/Cypress
      - save_cache:
          key: node-modules-{{ checksum "package.json" }}
          paths:
            - node_modules
      - store_artifacts:
          path: ~/GlobeTrotte/plz-out/gen/cypress
      - store_artifacts:
          path: ~/GlobeTrotte/plz-out/gen/coverage
      - store_artifacts:
          path: ~/GlobeTrotte/plz-out/gen/ava
      - store_artifacts:
          path: ~/GlobeTrotte/logs
