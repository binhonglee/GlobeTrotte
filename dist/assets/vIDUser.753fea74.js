import{C as re,E as T}from"./E.9c0db437.js";import{C as ie}from"./CHead.f280bebb.js";import{C as ne}from"./CLink.b580a7a9.js";import{a as Y,C as oe}from"./CLoadingTripPreviewCard.950aed55.js";import{r as o,o as r,c as d,a as i,e as g,F as N,g as R,p as z,b as Q,d as j,m as le,q as X,_ as D,t as E,l as m,h as k,w as p,i as h,a$ as Z,N as x,b8 as L,R as $,k as y,j as b,aW as B,G as O,b9 as de}from"./index.332ea37a.js";import{N as ue,a as ce}from"./CPlaces.709fde2e.js";import{C as pe}from"./CShare.631942e4.js";import{T as fe}from"./TripUtil.cf3da4e6.js";import{N as w}from"./NaiveUtils.e348e6ea.js";import"./Input.de5362c6.js";import"./DataProps.f815496d.js";const me=e=>(z("data-v-3dcf093c"),e=e(),Q(),e),he={class:"loading_view_user"},ge={class:"narrow_content"},_e=me(()=>g("h2",null,"Trips",-1));function ve(e,t,s,a,n,l){const u=o("n-skeleton"),c=o("n-divider"),f=o("CLoadingTripPreviewCard");return r(),d("div",he,[i(u,{class:"loading_user_name",height:"40px",width:"100px"}),g("div",ge,[i(u,{text:"",repeat:5})]),i(c),_e,(r(),d(N,null,R(5,_=>i(f,{key:_,wide:!0,"limit-height":!1})),64))])}const we=j({name:"CLoadingViewUser",components:{NCard:le,NDivider:X,NSkeleton:ue,CLoadingTripPreviewCard:Y}});var ye=D(we,[["render",ve],["__scopeId","data-v-3dcf093c"]]);const Ce=e=>(z("data-v-f5c5ff94"),e=e(),Q(),e),$e={class:"view_user"},ke={class:"userInfo narrow_content"},be={key:0,class:"userName left_col"},Se={key:1,class:"userBio"},Te={class:"externalLink"},Oe={key:3,class:"userInfoButtonGroups"},Ee=h("Logout"),Ue=h("Edit"),Ie={key:0,class:"viewUserTrips"},Le=Ce(()=>g("h2",null,"Trips",-1)),Ae={key:2,class:"createTripAlertDiv"},Ne=h("Seems like you have not shared any of your own trips."),Re=h("Create New Trip");function Be(e,t,s,a,n,l){const u=o("CExternalLink"),c=o("CShare"),f=o("n-button"),_=o("n-divider"),v=o("CLoadingTripPreviewCard"),C=o("CTripPreviewCard"),S=o("n-alert");return r(),d("div",$e,[g("div",ke,[e.showName?(r(),d("h2",be,E(e.user.details.name),1)):m("",!0),e.user.details.bio!==""?(r(),d("p",Se,E(e.user.details.bio),1)):m("",!0),g("div",Te,[e.user.details.link!==""?(r(),k(u,{key:0,underline:"hover",url:e.user.details.link.valueOf()},{default:p(()=>[h(E(e.user.details.link),1)]),_:1},8,["url"])):m("",!0)]),e.self?(r(),k(c,{key:2,shareURL:e.shareURL,onClick:e.onShare},null,8,["shareURL","onClick"])):m("",!0),e.self?(r(),d("div",Oe,[i(f,{class:"myAccountLogout left_col",type:"error",onClick:e.logout},{default:p(()=>[Ee]),_:1},8,["onClick"]),i(f,{class:"myAccountEdit right_col",type:"default",ref:"edit",onClick:e.toggleEdit},{default:p(()=>[Ue]),_:1},8,["onClick"])])):m("",!0)]),i(_,{class:"viewUserDivider"}),e.loading||e.self||!e.tripsEmpty?(r(),d("div",Ie,[Le,e.loading?(r(),d(N,{key:0},R(5,A=>i(v,{key:A,wide:!0,"limit-height":!1})),64)):(r(!0),d(N,{key:1},R(e.trips,A=>(r(),k(C,{trip:A,wide:!0,"limit-height":!1},null,8,["trip"]))),256)),e.self&&e.tripsEmpty?(r(),d("div",Ae,[i(S,{class:"createTripAlert",type:"default","show-icon":!1},{default:p(()=>[Ne,e.confirmed?(r(),k(f,{key:0,class:"createTripButton",type:"info",onClick:e.newTrip,size:"large"},{default:p(()=>[Re]),_:1},8,["onClick"])):m("",!0)]),_:1})])):m("",!0)])):m("",!0)])}const Pe=j({name:"CViewUser",components:{CExternalLink:ce,CShare:pe,CTripPreviewCard:oe,NAlert:Z,NButton:x,NDivider:X,CLoadingTripPreviewCard:Y},props:{user:{type:L,required:!0},showName:{type:Boolean,default:!0},self:{type:Boolean,default:!1},confirmed:{type:Boolean,default:!1}},emits:{logout(){return!0},toggleEdit(){return!0}},data:()=>({trips:[],tripsEmpty:!0,loading:!0,shareURL:""}),async beforeMount(){await this.genPopulateTrips()},async beforeUpdate(){await this.genPopulateTrips()},methods:{compareArray(e,t){if(e.length!==t.length)return!1;for(let s in e)if(e[s]!==t[s])return!1;return!0},async genPopulateTrips(){this.$data.loading=!0,this.$data.trips=this.$props.user.trips,fe.sortTripsMostRecentlyUpdated(this.$data.trips),this.$data.tripsEmpty=this.$data.trips.length<=0,this.$data.loading=!1},logout(){this.$emit("logout")},toggleEdit(){this.$emit("toggleEdit")},async newTrip(){await $.genRedirectTo(y.trip_New)},onShare(){let e=this.$props.user.details.username.valueOf();e===""&&(e=this.$props.user.details.ID.toString()),this.$data.shareURL=b.getAbsoluteURL(y.User,e)}}});var je=D(Pe,[["render",Be],["__scopeId","data-v-f5c5ff94"]]),P=(e=>(e.Server="server",e.Storage="storage",e))(P||{});function ee(e){return e.replaceAll("\\\\n",`
`)}function te(e){return e.replaceAll("\\n",`
`)}function De(e){return e.replaceAll("\\t","	").replaceAll("	","").replaceAll(`
`,"\\\\n").replaceAll("\\","\\\\")}function H(e,t){switch(t){case"server":return ee(e);case"storage":return te(e)}}function Ve(e,t,s,a){return e.ID===t.ID&&H(e.details.bio.valueOf(),s)===H(t.details.bio.valueOf(),a)&&e.details.email===t.details.email&&e.details.link===t.details.link&&e.details.name===t.details.name&&e.details.username===t.details.username}class V{static isPWA(){switch("production"){case"production":return window.matchMedia("(display-mode: standalone)").matches;case"development":return!0}return!0}}class F{constructor(t){this.order=t.order,this.key=t.key,this.obj=t.obj}static paramsToRecord(t,s,a){return{order:t,key:s,obj:a}}getOrder(){return this.order}getKey(){return this.key}incrementOrder(){return this.order++,this.order}}function J(e,t){if(t===null)return null;try{const s=JSON.parse(t),a=[];for(const n of s)a.push(new e(n));return a}catch{return null}}class se{constructor(){this.fromStorage=!1,this.completed=null,this.promise=null}}class ae{getStorage(){return localStorage.getItem(this.storage)}setStorage(t){localStorage.setItem(this.storage,JSON.stringify(t))}async genObjImpl(t,s,a){const n=new t;if(V.isPWA()){const l=J(s,this.getStorage());if(l!==null){for(const u of l)if(u.getKey()===a)return n.completed=u.getObj(),n.promise=this.genFetch(a),n.fromStorage=!0,n}}return n.completed=await this.genFetch(a),n.promise=null,n}storeObj(t,s,a,n){let l;try{l=J(s,this.getStorage())}catch{l=null}let u=0;if(l!==null){let c=0,f=!1;for(const[_,v]of l.entries()){if(v.getKey()===a){c=_,f=!0;break}v.getOrder()>u&&(u=v.getOrder(),c=_),v.incrementOrder()}(l.length>10||f)&&l.splice(c,1)}else l=[];l.push(new s(F.paramsToRecord(u,n,a))),this.setStorage(l)}}var W=(e=>(e.USER="user",e.USERNAME="username",e))(W||{});class U extends F{static fromJSON(t){return new U(t)}getObj(){return new L(JSON.parse(this.obj))}}class K extends se{}class G extends ae{constructor(){super(...arguments),this.storage=W.USER}async genFetch(t){const s=await b.genGET("username/"+t),a=new L(s);return V.isPWA()?s!==""?(this.storeObj(K,U,B.stringify(a),a.details.username.valueOf()),a):null:a}static genObj(t){return new G().genObjImpl(K,U,t)}}class I extends F{static fromJSON(t){return new I(t)}getObj(){return this.obj}}class q extends se{}class M extends ae{constructor(){super(...arguments),this.storage=W.USERNAME}async genFetch(t){const s=await b.genGET("v2/username/"+t);return V.isPWA()?s!==""?(this.storeObj(q,I,s,t),s):null:s}static genObj(t){return new M().genObjImpl(q,I,t)}}const Fe={class:"get_user"},We={key:0,class:"narrow_content accountUnconfirmedAlertBar"},Ge=h("Please confirm you email address to access the full site."),Me={key:1,class:"narrow_content tapToUpdate"},He=h("Press here to view latest version of this profile."),Je={key:3,class:"userinfo"},Ke={class:"title"},qe={class:"profile_info"},Ye={key:1,class:"narrow_content"},ze={class:"myAccountButtonGroups"},Qe=h("Save"),Xe=h("Cancel"),Ze={class:"myAccountDeletion"},xe=h("Delete Account");function et(e,t,s,a,n,l){const u=o("CHead"),c=o("n-alert"),f=o("CLink"),_=o("CLoadingViewUser"),v=o("CViewUser"),C=o("CEditItem"),S=o("n-button");return r(),d("div",Fe,[i(u,{title:e.user.details.name.valueOf(),description:e.user.details.bio.valueOf(),type:"profile"},null,8,["title","description"]),e.self&&!e.user.details.confirmed?(r(),d("div",We,[i(f,{class:"unconfirmedEmailLink",url:e.unconfirmedLink,underline:"never"},{default:p(()=>[i(c,{title:"Unconfirmed",type:"error"},{default:p(()=>[Ge]),_:1})]),_:1},8,["url"])])):m("",!0),e.updated!==null?(r(),d("div",Me,[i(c,{title:"There's an update!",type:"warning",onClick:e.update},{default:p(()=>[He]),_:1},8,["onClick"])])):m("",!0),e.user.ID===-1?(r(),k(_,{key:2})):(r(),d("div",Je,[g("h1",Ke,E(e.user.details.name),1),g("div",qe,[e.edit?(r(),d("div",Ye,[i(C,{label:"Name",ref:"name",val:e.user.details.name.valueOf()},null,8,["val"]),i(C,{label:"Username",ref:"username",val:e.user.details.username.valueOf(),placeholder:"Set a username"},null,8,["val"]),i(C,{label:"Email",ref:"email",val:e.user.details.email.valueOf()},null,8,["val"]),i(C,{label:"Link",ref:"link",val:e.user.details.link.valueOf()},null,8,["val"]),i(C,{label:"Bio",type:"textarea",ref:"bio",val:e.user.details.bio.valueOf(),"row-min-count":3,"val-max-count":1e3},null,8,["val"]),g("div",ze,[i(S,{class:"myAccountSave left_col",type:"info",onClick:e.save},{default:p(()=>[Qe]),_:1},8,["onClick"]),i(S,{class:"myAccountCancel right_col",type:"default",ref:"cancel",onClick:e.toggleEdit},{default:p(()=>[Xe]),_:1},8,["onClick"])]),g("div",Ze,[i(S,{class:"myAccountDelete",type:"error",onClick:e.confirmDelete},{default:p(()=>[xe]),_:1},8,["onClick"])])])):(r(),k(v,{key:0,user:e.user,showName:!1,self:e.self,onLogout:e.logout,onToggleEdit:e.toggleEdit},null,8,["user","self","onLogout","onToggleEdit"]))])]))])}const tt=j({components:{CEditItem:re,CHead:ie,CLink:ne,CLoadingViewUser:ye,CViewUser:je,NAlert:Z,NButton:x},data:()=>({user:new L,edit:!1,self:!1,unconfirmedLink:y.unconfirmed_Email,updated:null,loadingBar:O.loadingBar()}),async beforeMount(){await this.init()},methods:{async init(){w.init();const e=O.paramID();if(e===void 0){await $.genRedirectTo(y.NotFound);return}if(isNaN(Number(e))){const t=await G.genObj(e);if(t.completed!==null&&(this.$data.user=t.completed,this.dataProcessing(t.fromStorage)),t.promise!==null){const s=await t.promise;s!==null&&!Ve(s,this.$data.user,P.Server,P.Storage)&&(this.$data.updated=s)}}else{const s=(await M.genObj(e)).completed;if(s!==null&&s!=="")return await $.genRedirectTo(y.User+"/"+s),await this.init()}this.$data.user.ID===-1&&(O.paramID()===O.getCurrentUsername()&&await this.logout(),w.dialogError({title:"User not found",content:"The user you are looking for does not exist.",positiveText:"OK",onPositiveClick:async()=>{await $.genRedirectTo(y.Landing)}}))},dataProcessing(e){this.$data.user.ID!==-1&&(this.$data.self=O.getIsCurrentUser(this.$data.user.ID.valueOf()),e?this.$data.user.details.bio=te(this.$data.user.details.bio.valueOf()):this.$data.user.details.bio=ee(this.$data.user.details.bio.valueOf()))},update(){this.$data.updated!==null&&(this.$data.user=this.$data.updated,this.dataProcessing(!1),this.$data.updated=null)},confirmDelete(){w.dialogWarning({title:"Delete account",content:"Are you sure you want to delete this account? All trips owned by this account will also be deleted. THIS PROCESS IS IRREVERSIBLE.",positiveText:"Confirm",negativeText:"Cancel",onPositiveClick:async()=>{await this.deleteAccount()}})},async deleteAccount(){var t,s,a;(t=this.$data.loadingBar)==null||t.start(),await b.genDELETE("v2/user/"+this.$data.user.ID,B.stringify(this.$data.user.details))?(localStorage.clear(),(s=this.$data.loadingBar)==null||s.finish(),w.messageInfo("Your account is now deleted."),await $.genRedirectTo(y.Landing)):((a=this.$data.loadingBar)==null||a.error(),w.messageError("Account deletion attempt failed."))},async save(){var s,a,n;(s=this.$data.loadingBar)==null||s.start();const e=new de({id:this.$data.user.ID,name:T.getVal(this,"name"),email:T.getVal(this,"email"),bio:De(T.getVal(this,"bio")),link:T.getVal(this,"link"),username:T.getVal(this,"username"),confirmed:this.$data.user.details.confirmed});await b.genPOST("v2/user/"+this.$data.user.ID,B.stringify(e))!==!1?(this.toggleEdit(),(a=this.$data.loadingBar)==null||a.finish(),w.messageSuccess("Profile updated successfully!"),await this.init()):((n=this.$data.loadingBar)==null||n.error(),w.dialogError({title:"Fail",content:"Save was unsuccessful. Please try again later.",positiveText:"OK"}))},async logout(){await b.genGET("logout"),localStorage.removeItem("userobj"),w.messageSuccess("You are now logged out."),await $.genRedirectTo(y.Landing)},toggleEdit(){this.$data.edit=!this.$data.edit}}});var ft=D(tt,[["render",et],["__scopeId","data-v-1fb67d54"]]);export{ft as default};
