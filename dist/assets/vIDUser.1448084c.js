import{C as M,E as T}from"./E.3f827e06.js";import{C as q}from"./CHead.e1fc57b4.js";import{C as K}from"./CLink.ee7e2d36.js";import{a as F,C as Y}from"./CLoadingTripPreviewCard.3ded6310.js";import{r as n,o as r,c as l,a as i,e as m,F as P,g as N,p as j,b as W,d as R,m as z,q as G,_ as D,t as E,l as p,h as C,w as c,i as f,N as H,bf as b,G as I,R as w,k as g,j as $,aX as O,bg as X}from"./index.19e11df1.js";import{N as Q,a as Z}from"./CPlaces.07ccab23.js";import{C as x}from"./CShare.473eeab6.js";import{T as ee}from"./TripUtil.cf3da4e6.js";import{N as J}from"./Alert.79602c38.js";import{N as h}from"./NaiveUtils.e256bf3a.js";import"./Input.19065b66.js";import"./DataProps.62b96c84.js";const te=e=>(j("data-v-3dcf093c"),e=e(),W(),e),se={class:"loading_view_user"},ae={class:"narrow_content"},re=te(()=>m("h2",null,"Trips",-1));function ie(e,s,t,a,o,k){const u=n("n-skeleton"),d=n("n-divider"),_=n("CLoadingTripPreviewCard");return r(),l("div",se,[i(u,{class:"loading_user_name",height:"40px",width:"100px"}),m("div",ae,[i(u,{text:"",repeat:5})]),i(d),re,(r(),l(P,null,N(5,U=>i(_,{key:U,wide:!0,"limit-height":!1})),64))])}const oe=R({name:"CLoadingViewUser",components:{NCard:z,NDivider:G,NSkeleton:Q,CLoadingTripPreviewCard:F}});var ne=D(oe,[["render",ie],["__scopeId","data-v-3dcf093c"]]);const le=e=>(j("data-v-cf9cf05c"),e=e(),W(),e),de={class:"view_user"},ce={class:"userInfo narrow_content"},ue={key:0,class:"userName left_col"},pe={key:1,class:"userBio"},me={class:"externalLink"},fe={key:3,class:"userInfoButtonGroups"},he=f("Logout"),ge=f("Edit"),_e={key:0,class:"viewUserTrips"},ve=le(()=>m("h2",null,"Trips",-1)),ye={key:2,class:"createTripAlertDiv"},we=f("Seems like you have not shared any of your own trips."),Ce=f("Create New Trip");function $e(e,s,t,a,o,k){const u=n("CExternalLink"),d=n("CShare"),_=n("n-button"),U=n("n-divider"),L=n("CLoadingTripPreviewCard"),v=n("CTripPreviewCard"),S=n("n-alert");return r(),l("div",de,[m("div",ce,[e.showName?(r(),l("h2",ue,E(e.user.details.name),1)):p("",!0),e.user.details.bio!==""?(r(),l("p",pe,E(e.user.details.bio),1)):p("",!0),m("div",me,[e.user.details.link!==""?(r(),C(u,{key:0,underline:"hover",url:e.user.details.link.valueOf()},{default:c(()=>[f(E(e.user.details.link),1)]),_:1},8,["url"])):p("",!0)]),e.self?(r(),C(d,{key:2,shareURL:e.shareURL,onClick:e.onShare},null,8,["shareURL","onClick"])):p("",!0),e.self?(r(),l("div",fe,[i(_,{class:"myAccountLogout left_col",type:"error",onClick:e.logout},{default:c(()=>[he]),_:1},8,["onClick"]),i(_,{class:"myAccountEdit right_col",type:"default",ref:"edit",onClick:e.toggleEdit},{default:c(()=>[ge]),_:1},8,["onClick"])])):p("",!0)]),i(U,{class:"viewUserDivider"}),e.loading||e.self||!e.tripsEmpty?(r(),l("div",_e,[ve,e.loading?(r(),l(P,{key:0},N(5,A=>i(L,{key:A,wide:!0,"limit-height":!1})),64)):(r(!0),l(P,{key:1},N(e.trips,A=>(r(),C(v,{trip:A,wide:!0,"limit-height":!1},null,8,["trip"]))),256)),e.self&&e.tripsEmpty?(r(),l("div",ye,[i(S,{class:"createTripAlert",type:"default","show-icon":!1},{default:c(()=>[we,e.confirmed?(r(),C(_,{key:0,class:"createTripButton",type:"info",onClick:e.newTrip,size:"large"},{default:c(()=>[Ce]),_:1},8,["onClick"])):p("",!0)]),_:1})])):p("",!0)])):p("",!0)])}const ke=R({name:"CViewUser",components:{CExternalLink:Z,CShare:x,CTripPreviewCard:Y,NAlert:J,NButton:H,NDivider:G,CLoadingTripPreviewCard:F},props:{user:{type:b,required:!0},showName:{type:Boolean,default:!0},self:{type:Boolean,default:!1},confirmed:{type:Boolean,default:!1}},emits:{logout(){return!0},toggleEdit(){return!0}},data:()=>({trips:[],lastPopulated:[],tripsEmpty:!0,loading:!0,shareURL:""}),async beforeMount(){await this.genPopulateTrips()},async beforeUpdate(){await this.genPopulateTrips()},methods:{compareArray(e,s){if(e.length!==s.length)return!1;for(let t in e)if(e[t]!==s[t])return!1;return!0},async genPopulateTrips(){if(this.$data.loading=!0,this.compareArray(this.$data.lastPopulated,this.$props.user.trips)){this.$data.loading=!1;return}this.$data.trips=await Promise.all(this.$props.user.trips.map(async e=>await I.genTrip(e.ID.valueOf()))),ee.sortTripsMostRecentlyUpdated(this.$data.trips),this.$data.tripsEmpty=this.$data.trips.length<=0,this.$data.lastPopulated=this.$props.user.trips,this.$data.loading=!1},logout(){this.$emit("logout")},toggleEdit(){this.$emit("toggleEdit")},async newTrip(){await w.genRedirectTo(g.trip_New)},onShare(){let e=this.$props.user.details.username.valueOf();e===""&&(e=this.$props.user.details.ID.toString()),this.$data.shareURL=$.getAbsoluteURL(g.User,e)}}});var Ue=D(ke,[["render",$e],["__scopeId","data-v-cf9cf05c"]]);class y{static create(s,t){const a=new y;return a.order=s,a.key=t.ID,a.username=t.details.username,a.obj=O.stringify(t),a}static fromStorage(s){if(s===null)return null;const t=JSON.parse(s),a=[];for(const o of t)a.push(this.fromJSON(o));return a}static fromJSON(s){const t=new y;return t.order=s.order,t.key=s.key,t.username=s.username,t.obj=s.obj,t}getObj(){return new b(JSON.parse(this.obj))}}class B{constructor(){this.fromStorage=!1}}class V{static isPWA(){return window.matchMedia("(display-mode: standalone)").matches}static async genUser(s){const t=new B;if(this.isPWA()){const a=y.fromStorage(localStorage.getItem("users"));for(const o of a)o.key===s&&(t.completed=o.getObj(),t.promise=this.genFetchUser(s),t.fromStorage=!0)}else t.completed=await this.genFetchUser(s),t.promise=null;return t}static async genFetchUser(s){const t=await $.genGET("v2/user/"+s),a=new b(t);return this.isPWA()&&t!==""&&this.storeUser(a),a}static async genUserFromUsername(s){const t=new B;if(this.isPWA()){let a;try{a=y.fromStorage(localStorage.getItem("users"))}catch{a=null}if(a!==null){for(const o of a)if(o.username===s)return t.completed=o.getObj(),t.promise=this.genFetchUsername(s),t.fromStorage=!0,t}}return t.completed=await this.genFetchUsername(s),t.promise=null,t}static async genFetchUsername(s){const t=await $.genGET("username/"+s),a=new b(t);return this.isPWA()&&t!==""&&this.storeUser(a),a}static storeUser(s){let t;try{t=y.fromStorage(localStorage.getItem("users"))}catch{t=null}let a=0;if(t!==null){let o=0,k=!1;for(const[u,d]of t.entries()){if(d.key===s.ID){o=u,k=!0;break}d.order>a&&(a=d.order,o=u),d.order++}(t.length>10||k)&&t.splice(o,1)}else t=[];t.push(y.create(a,s)),localStorage.setItem("users",JSON.stringify(t))}}const Se={class:"get_user"},Te={key:0,class:"narrow_content accountUnconfirmedAlertBar"},be=f("Please confirm you email address to access the full site."),Ee={key:2,class:"userinfo"},Ie={class:"title"},Le={class:"profile_info"},Ae={key:1,class:"narrow_content"},Pe={class:"myAccountButtonGroups"},Ne=f("Save"),Oe=f("Cancel"),Re={class:"myAccountDeletion"},De=f("Delete Account");function Be(e,s,t,a,o,k){const u=n("CHead"),d=n("n-alert"),_=n("CLink"),U=n("CLoadingViewUser"),L=n("CViewUser"),v=n("CEditItem"),S=n("n-button");return r(),l("div",Se,[i(u,{title:e.user.details.name.valueOf(),description:e.user.details.bio.valueOf(),type:"profile"},null,8,["title","description"]),e.self&&!e.user.details.confirmed?(r(),l("div",Te,[i(_,{class:"unconfirmedEmailLink",url:e.unconfirmedLink,underline:"never"},{default:c(()=>[i(d,{title:"Unconfirmed",type:"error"},{default:c(()=>[be]),_:1})]),_:1},8,["url"])])):p("",!0),e.user.ID===-1?(r(),C(U,{key:1})):(r(),l("div",Ee,[m("h1",Ie,E(e.user.details.name),1),m("div",Le,[e.edit?(r(),l("div",Ae,[i(v,{label:"Name",ref:"name",val:e.user.details.name.valueOf()},null,8,["val"]),i(v,{label:"Username",ref:"username",val:e.user.details.username.valueOf(),placeholder:"Set a username"},null,8,["val"]),i(v,{label:"Email",ref:"email",val:e.user.details.email.valueOf()},null,8,["val"]),i(v,{label:"Link",ref:"link",val:e.user.details.link.valueOf()},null,8,["val"]),i(v,{label:"Bio",type:"textarea",ref:"bio",val:e.user.details.bio.valueOf(),"row-min-count":3,"val-max-count":1e3},null,8,["val"]),m("div",Pe,[i(S,{class:"myAccountSave left_col",type:"info",onClick:e.save},{default:c(()=>[Ne]),_:1},8,["onClick"]),i(S,{class:"myAccountCancel right_col",type:"default",ref:"cancel",onClick:e.toggleEdit},{default:c(()=>[Oe]),_:1},8,["onClick"])]),m("div",Re,[i(S,{class:"myAccountDelete",type:"error",onClick:e.confirmDelete},{default:c(()=>[De]),_:1},8,["onClick"])])])):(r(),C(L,{key:0,user:e.user,showName:!1,self:e.self,onLogout:e.logout,onToggleEdit:e.toggleEdit},null,8,["user","self","onLogout","onToggleEdit"]))])]))])}const Ve=R({components:{CEditItem:M,CHead:q,CLink:K,CLoadingViewUser:ne,CViewUser:Ue,NAlert:J,NButton:H},data:()=>({user:new b,edit:!1,self:!1,unconfirmedLink:g.unconfirmed_Email,loadingBar:I.loadingBar()}),async beforeMount(){await this.init()},methods:{async init(){h.init();const e=I.paramID();if(e===void 0){await w.genRedirectTo(g.NotFound);return}let s;if(isNaN(Number(e)))s=await V.genUserFromUsername(e);else{s=await V.genUser(Number(e));const t=s.completed;t.details.username!==""&&await w.genRedirectTo(g.User+"/"+t.details.username)}this.$data.user=s.completed,this.dataProcessing(s.fromStorage),s.promise!==null&&(this.$data.user=await s.promise,this.dataProcessing(!1)),this.$data.user.ID===-1&&h.dialogError({title:"User not found",content:"The user you are looking for does not exist.",positiveText:"OK",onPositiveClick:async()=>{await w.genRedirectTo(g.Landing)}})},dataProcessing(e){this.$data.user.ID!==-1&&(this.$data.self=I.getIsCurrentUser(this.$data.user.ID.valueOf()),e?this.$data.user.details.bio=this.$data.user.details.bio.replaceAll("\\n",`
`):this.$data.user.details.bio=this.$data.user.details.bio.replaceAll("\\\\n",`
`))},confirmDelete(){h.dialogWarning({title:"Delete account",content:"Are you sure you want to delete this account? All trips owned by this account will also be deleted. THIS PROCESS IS IRREVERSIBLE.",positiveText:"Confirm",negativeText:"Cancel",onPositiveClick:async()=>{await this.deleteAccount()}})},async deleteAccount(){var s,t,a;(s=this.$data.loadingBar)==null||s.start(),await $.genDELETE("v2/user/"+this.$data.user.ID,O.stringify(this.$data.user.details))?(localStorage.clear(),(t=this.$data.loadingBar)==null||t.finish(),h.messageInfo("Your account is now deleted."),await w.genRedirectTo(g.Landing)):((a=this.$data.loadingBar)==null||a.error(),h.messageError("Account deletion attempt failed."))},async save(){var t,a,o;(t=this.$data.loadingBar)==null||t.start();const e=new X({id:this.$data.user.ID,name:T.getVal(this,"name"),email:T.getVal(this,"email"),bio:T.getVal(this,"bio").replaceAll("\\t","	").replaceAll("	","").replaceAll(`
`,"\\\\n").replaceAll("\\","\\\\"),link:T.getVal(this,"link"),username:T.getVal(this,"username"),confirmed:this.$data.user.details.confirmed});await $.genPOST("v2/user/"+this.$data.user.ID,O.stringify(e))!==!1?(this.toggleEdit(),(a=this.$data.loadingBar)==null||a.finish(),h.messageSuccess("Profile updated successfully!"),await this.init()):((o=this.$data.loadingBar)==null||o.error(),h.dialogError({title:"Fail",content:"Save was unsuccessful. Please try again later.",positiveText:"OK"}))},async logout(){await $.genGET("logout"),localStorage.removeItem("userobj"),h.messageSuccess("You are now logged out."),await w.genRedirectTo(g.Landing)},toggleEdit(){this.$data.edit=!this.$data.edit}}});var Qe=D(Ve,[["render",Be],["__scopeId","data-v-f06ad33a"]]);export{Qe as default};
