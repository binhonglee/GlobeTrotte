import{C as Q,E as b}from"./E.071947bd.js";import{C as Z}from"./CHead.affcb33d.js";import{C as x}from"./CLink.777a1a87.js";import{a as H,C as ee}from"./CLoadingTripPreviewCard.d7494d16.js";import{r as n,o as i,c as l,a as o,e as f,F as B,g as D,p as J,b as q,d as P,m as te,q as M,_ as V,t as I,l as c,h as C,w as u,i as p,aY as Y,N as W,b9 as E,R as w,k as g,j as $,aX as R,G as T,ba as se}from"./index.52ef9f93.js";import{N as re,a as ae}from"./CPlaces.70028aa9.js";import{C as ie}from"./CShare.f451b19c.js";import{T as oe}from"./TripUtil.cf3da4e6.js";import{N as h}from"./NaiveUtils.455af69d.js";import"./Input.1804a610.js";import"./DataProps.b06b03b4.js";const ne=e=>(J("data-v-3dcf093c"),e=e(),q(),e),le={class:"loading_view_user"},de={class:"narrow_content"},ue=ne(()=>f("h2",null,"Trips",-1));function ce(e,s,t,r,a,k){const m=n("n-skeleton"),d=n("n-divider"),v=n("CLoadingTripPreviewCard");return i(),l("div",le,[o(m,{class:"loading_user_name",height:"40px",width:"100px"}),f("div",de,[o(m,{text:"",repeat:5})]),o(d),ue,(i(),l(B,null,D(5,S=>o(v,{key:S,wide:!0,"limit-height":!1})),64))])}const pe=P({name:"CLoadingViewUser",components:{NCard:te,NDivider:M,NSkeleton:re,CLoadingTripPreviewCard:H}});var me=V(pe,[["render",ce],["__scopeId","data-v-3dcf093c"]]);const fe=e=>(J("data-v-f5c5ff94"),e=e(),q(),e),he={class:"view_user"},ge={class:"userInfo narrow_content"},_e={key:0,class:"userName left_col"},ve={key:1,class:"userBio"},ye={class:"externalLink"},we={key:3,class:"userInfoButtonGroups"},Ce=p("Logout"),$e=p("Edit"),ke={key:0,class:"viewUserTrips"},Se=fe(()=>f("h2",null,"Trips",-1)),Ue={key:2,class:"createTripAlertDiv"},be=p("Seems like you have not shared any of your own trips."),Te=p("Create New Trip");function Ee(e,s,t,r,a,k){const m=n("CExternalLink"),d=n("CShare"),v=n("n-button"),S=n("n-divider"),L=n("CLoadingTripPreviewCard"),y=n("CTripPreviewCard"),U=n("n-alert");return i(),l("div",he,[f("div",ge,[e.showName?(i(),l("h2",_e,I(e.user.details.name),1)):c("",!0),e.user.details.bio!==""?(i(),l("p",ve,I(e.user.details.bio),1)):c("",!0),f("div",ye,[e.user.details.link!==""?(i(),C(m,{key:0,underline:"hover",url:e.user.details.link.valueOf()},{default:u(()=>[p(I(e.user.details.link),1)]),_:1},8,["url"])):c("",!0)]),e.self?(i(),C(d,{key:2,shareURL:e.shareURL,onClick:e.onShare},null,8,["shareURL","onClick"])):c("",!0),e.self?(i(),l("div",we,[o(v,{class:"myAccountLogout left_col",type:"error",onClick:e.logout},{default:u(()=>[Ce]),_:1},8,["onClick"]),o(v,{class:"myAccountEdit right_col",type:"default",ref:"edit",onClick:e.toggleEdit},{default:u(()=>[$e]),_:1},8,["onClick"])])):c("",!0)]),o(S,{class:"viewUserDivider"}),e.loading||e.self||!e.tripsEmpty?(i(),l("div",ke,[Se,e.loading?(i(),l(B,{key:0},D(5,N=>o(L,{key:N,wide:!0,"limit-height":!1})),64)):(i(!0),l(B,{key:1},D(e.trips,N=>(i(),C(y,{trip:N,wide:!0,"limit-height":!1},null,8,["trip"]))),256)),e.self&&e.tripsEmpty?(i(),l("div",Ue,[o(U,{class:"createTripAlert",type:"default","show-icon":!1},{default:u(()=>[be,e.confirmed?(i(),C(v,{key:0,class:"createTripButton",type:"info",onClick:e.newTrip,size:"large"},{default:u(()=>[Te]),_:1},8,["onClick"])):c("",!0)]),_:1})])):c("",!0)])):c("",!0)])}const Ie=P({name:"CViewUser",components:{CExternalLink:ae,CShare:ie,CTripPreviewCard:ee,NAlert:Y,NButton:W,NDivider:M,CLoadingTripPreviewCard:H},props:{user:{type:E,required:!0},showName:{type:Boolean,default:!0},self:{type:Boolean,default:!1},confirmed:{type:Boolean,default:!1}},emits:{logout(){return!0},toggleEdit(){return!0}},data:()=>({trips:[],tripsEmpty:!0,loading:!0,shareURL:""}),async beforeMount(){await this.genPopulateTrips()},async beforeUpdate(){await this.genPopulateTrips()},methods:{compareArray(e,s){if(e.length!==s.length)return!1;for(let t in e)if(e[t]!==s[t])return!1;return!0},async genPopulateTrips(){this.$data.loading=!0,this.$data.trips=this.$props.user.trips,oe.sortTripsMostRecentlyUpdated(this.$data.trips),this.$data.tripsEmpty=this.$data.trips.length<=0,this.$data.loading=!1},logout(){this.$emit("logout")},toggleEdit(){this.$emit("toggleEdit")},async newTrip(){await w.genRedirectTo(g.trip_New)},onShare(){let e=this.$props.user.details.username.valueOf();e===""&&(e=this.$props.user.details.ID.toString()),this.$data.shareURL=$.getAbsoluteURL(g.User,e)}}});var Oe=V(Ie,[["render",Ee],["__scopeId","data-v-f5c5ff94"]]),A=(e=>(e.Server="server",e.Storage="storage",e))(A||{});function z(e){return e.replaceAll("\\\\n",`
`)}function X(e){return e.replaceAll("\\n",`
`)}function Le(e){return e.replaceAll("\\t","	").replaceAll("	","").replaceAll(`
`,"\\\\n").replaceAll("\\","\\\\")}function F(e,s){switch(s){case"server":return z(e);case"storage":return X(e)}}function Ne(e,s,t,r){return e.ID===s.ID&&F(e.details.bio.valueOf(),t)===F(s.details.bio.valueOf(),r)&&e.details.email===s.details.email&&e.details.link===s.details.link&&e.details.name===s.details.name&&e.details.username===s.details.username}var O=(e=>(e[e.NumberOnly=0]="NumberOnly",e[e.StringOnly=1]="StringOnly",e[e.Both=2]="Both",e))(O||{});class j{constructor(s,t=0){this.order=s.order,this.numberKey=s.numberKey,this.stringKey=s.stringKey,this.obj=s.obj,this.keyType=t}static paramsToRecord(s,t,r,a){return{order:s,numberKey:t,stringKey:r,obj:a}}getOrder(){return this.order}getNumberKey(){return this.numberKey}getStringKey(){return this.stringKey}incrementOrder(){return this.order++,this.order}}class _ extends j{static create(s,t){return new _(j.paramsToRecord(s,t.ID.valueOf(),t.details.username.valueOf(),R.stringify(t)),O.Both)}static fromStorage(s){if(s===null)return null;try{const t=JSON.parse(s),r=[];for(const a of t)r.push(new _(a,O.Both));return r}catch{return null}}static fromJSON(s){return new _(s,O.Both)}getObj(){return new E(JSON.parse(this.obj))}}class K{constructor(){this.fromStorage=!1,this.completed=void 0,this.promise=null}}class G{static async genUser(s){const t=new K;{const r=_.fromStorage(localStorage.getItem("users"));if(r!==null)for(const a of r)a.getNumberKey()===s&&(t.completed=a.getObj(),t.promise=this.genFetchUser(s),t.fromStorage=!0)}return t}static async genFetchUser(s){const t=await $.genGET("v2/user/"+s),r=new E(t);return t!==""&&this.storeUser(r),r}static async genUserFromUsername(s){const t=new K;{let r;try{r=_.fromStorage(localStorage.getItem("users"))}catch{r=null}if(r!==null){for(const a of r)if(a.getStringKey()===s)return t.completed=a.getObj(),t.promise=this.genFetchUsername(s),t.fromStorage=!0,t}}return t.completed=await this.genFetchUsername(s),t.promise=null,t}static async genFetchUsername(s){const t=await $.genGET("username/"+s),r=new E(t);return t!==""&&this.storeUser(r),r}static storeUser(s){let t;try{t=_.fromStorage(localStorage.getItem("users"))}catch{t=null}let r=0;if(t!==null){let a=0,k=!1;for(const[m,d]of t.entries()){if(d.getNumberKey()===s.ID){a=m,k=!0;break}d.getOrder()>r&&(r=d.getOrder(),a=m),d.incrementOrder()}(t.length>10||k)&&t.splice(a,1)}else t=[];t.push(_.create(r,s)),localStorage.setItem("users",JSON.stringify(t))}}const Be={class:"get_user"},De={key:0,class:"narrow_content accountUnconfirmedAlertBar"},Re=p("Please confirm you email address to access the full site."),Ae={key:1,class:"narrow_content tapToUpdate"},Pe=p("Press here to view latest version of this profile."),Ve={key:3,class:"userinfo"},Fe={class:"title"},je={class:"profile_info"},Ke={key:1,class:"narrow_content"},Ge={class:"myAccountButtonGroups"},He=p("Save"),Je=p("Cancel"),qe={class:"myAccountDeletion"},Me=p("Delete Account");function Ye(e,s,t,r,a,k){const m=n("CHead"),d=n("n-alert"),v=n("CLink"),S=n("CLoadingViewUser"),L=n("CViewUser"),y=n("CEditItem"),U=n("n-button");return i(),l("div",Be,[o(m,{title:e.user.details.name.valueOf(),description:e.user.details.bio.valueOf(),type:"profile"},null,8,["title","description"]),e.self&&!e.user.details.confirmed?(i(),l("div",De,[o(v,{class:"unconfirmedEmailLink",url:e.unconfirmedLink,underline:"never"},{default:u(()=>[o(d,{title:"Unconfirmed",type:"error"},{default:u(()=>[Re]),_:1})]),_:1},8,["url"])])):c("",!0),e.updated!==null?(i(),l("div",Ae,[o(d,{title:"There's an update!",type:"warning",onClick:e.update},{default:u(()=>[Pe]),_:1},8,["onClick"])])):c("",!0),e.user.ID===-1?(i(),C(S,{key:2})):(i(),l("div",Ve,[f("h1",Fe,I(e.user.details.name),1),f("div",je,[e.edit?(i(),l("div",Ke,[o(y,{label:"Name",ref:"name",val:e.user.details.name.valueOf()},null,8,["val"]),o(y,{label:"Username",ref:"username",val:e.user.details.username.valueOf(),placeholder:"Set a username"},null,8,["val"]),o(y,{label:"Email",ref:"email",val:e.user.details.email.valueOf()},null,8,["val"]),o(y,{label:"Link",ref:"link",val:e.user.details.link.valueOf()},null,8,["val"]),o(y,{label:"Bio",type:"textarea",ref:"bio",val:e.user.details.bio.valueOf(),"row-min-count":3,"val-max-count":1e3},null,8,["val"]),f("div",Ge,[o(U,{class:"myAccountSave left_col",type:"info",onClick:e.save},{default:u(()=>[He]),_:1},8,["onClick"]),o(U,{class:"myAccountCancel right_col",type:"default",ref:"cancel",onClick:e.toggleEdit},{default:u(()=>[Je]),_:1},8,["onClick"])]),f("div",qe,[o(U,{class:"myAccountDelete",type:"error",onClick:e.confirmDelete},{default:u(()=>[Me]),_:1},8,["onClick"])])])):(i(),C(L,{key:0,user:e.user,showName:!1,self:e.self,onLogout:e.logout,onToggleEdit:e.toggleEdit},null,8,["user","self","onLogout","onToggleEdit"]))])]))])}const We=P({components:{CEditItem:Q,CHead:Z,CLink:x,CLoadingViewUser:me,CViewUser:Oe,NAlert:Y,NButton:W},data:()=>({user:new E,edit:!1,self:!1,unconfirmedLink:g.unconfirmed_Email,updated:null,loadingBar:T.loadingBar()}),async beforeMount(){await this.init()},methods:{async init(){h.init();const e=T.paramID();if(e===void 0){await w.genRedirectTo(g.NotFound);return}let s;if(isNaN(Number(e)))s=await G.genUserFromUsername(e);else{s=await G.genUser(Number(e));const t=s.completed;t!==void 0&&t.details.username!==""&&await w.genRedirectTo(g.User+"/"+t.details.username)}if(s.completed!==void 0&&(this.$data.user=s.completed,this.dataProcessing(s.fromStorage)),s.promise!==null){const t=await s.promise;Ne(t,this.$data.user,A.Server,A.Storage)||(this.$data.updated=t)}this.$data.user.ID===-1&&(T.paramID()===T.getCurrentUsername()&&await this.logout(),h.dialogError({title:"User not found",content:"The user you are looking for does not exist.",positiveText:"OK",onPositiveClick:async()=>{await w.genRedirectTo(g.Landing)}}))},dataProcessing(e){this.$data.user.ID!==-1&&(this.$data.self=T.getIsCurrentUser(this.$data.user.ID.valueOf()),e?this.$data.user.details.bio=X(this.$data.user.details.bio.valueOf()):this.$data.user.details.bio=z(this.$data.user.details.bio.valueOf()))},update(){this.$data.updated!==null&&(this.$data.user=this.$data.updated,this.dataProcessing(!1),this.$data.updated=null)},confirmDelete(){h.dialogWarning({title:"Delete account",content:"Are you sure you want to delete this account? All trips owned by this account will also be deleted. THIS PROCESS IS IRREVERSIBLE.",positiveText:"Confirm",negativeText:"Cancel",onPositiveClick:async()=>{await this.deleteAccount()}})},async deleteAccount(){var s,t,r;(s=this.$data.loadingBar)==null||s.start(),await $.genDELETE("v2/user/"+this.$data.user.ID,R.stringify(this.$data.user.details))?(localStorage.clear(),(t=this.$data.loadingBar)==null||t.finish(),h.messageInfo("Your account is now deleted."),await w.genRedirectTo(g.Landing)):((r=this.$data.loadingBar)==null||r.error(),h.messageError("Account deletion attempt failed."))},async save(){var t,r,a;(t=this.$data.loadingBar)==null||t.start();const e=new se({id:this.$data.user.ID,name:b.getVal(this,"name"),email:b.getVal(this,"email"),bio:Le(b.getVal(this,"bio")),link:b.getVal(this,"link"),username:b.getVal(this,"username"),confirmed:this.$data.user.details.confirmed});await $.genPOST("v2/user/"+this.$data.user.ID,R.stringify(e))!==!1?(this.toggleEdit(),(r=this.$data.loadingBar)==null||r.finish(),h.messageSuccess("Profile updated successfully!"),await this.init()):((a=this.$data.loadingBar)==null||a.error(),h.dialogError({title:"Fail",content:"Save was unsuccessful. Please try again later.",positiveText:"OK"}))},async logout(){await $.genGET("logout"),localStorage.removeItem("userobj"),h.messageSuccess("You are now logged out."),await w.genRedirectTo(g.Landing)},toggleEdit(){this.$data.edit=!this.$data.edit}}});var ot=V(We,[["render",Ye],["__scopeId","data-v-2c0ed7e4"]]);export{ot as default};
